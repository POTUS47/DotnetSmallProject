<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="WTEMaui.Views.DashboardPage"
             Title=""
             BackgroundColor="#F8FDF8">

    <!-- 使用Grid作为根容器，以便叠加图片预览弹窗 -->
    <Grid>
        <ScrollView>
            <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto"
                  RowSpacing="20"
                  Padding="20">

                <!-- 第0行：美化的标题区域 -->
                <Frame Grid.Row="0"
                       BackgroundColor="#E8F5E8"
                       CornerRadius="16"
                       Padding="20,16"
                       HasShadow="False"
                       BorderColor="Transparent">
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout Grid.Column="0"
                                             Spacing="4">
                            <Label Text="健康饮食记录"
                                   FontSize="24"
                                   FontAttributes="Bold"
                                   TextColor="#2D5016"/>
                            <Label Text="记录每一餐，守护每一天"
                                   FontSize="14"
                                   TextColor="#7B9A5C"/>
                        </VerticalStackLayout>

                        <Button Grid.Column="1"
                                Text="⚙️"
                                BackgroundColor="#FFFFFF"
                                TextColor="#2D5016"
                                FontSize="18"
                                WidthRequest="50"
                                HeightRequest="50"
                                CornerRadius="22"
                                BorderColor="#A8C090"
                                BorderWidth="1"
                                Clicked="OnSettingsClicked"/>
                    </Grid>
                </Frame>

                <!-- 第1行：重新设计的按钮区域 -->
                <Frame Grid.Row="1"
                       BackgroundColor="White"
                       CornerRadius="16"
                       Padding="16"
                       HasShadow="True"
                       BorderColor="#E8F5E8">
                    <Grid RowDefinitions="Auto,Auto"
                          RowSpacing="12">
                        <!-- 第一行：前两个按钮并排 -->
                        <Grid Grid.Row="0"
                              ColumnDefinitions="*,*"
                              ColumnSpacing="12">
                            <Button Grid.Column="0"
                                    BackgroundColor="#4CAF50"
                                    TextColor="White"
                                    CornerRadius="12"
                                    HeightRequest="80"
                                    FontSize="15"
                                    FontAttributes="Bold"
                                    Clicked="OnTakePhotoClicked">
                                <Button.Text>
                                    <![CDATA[📷
拍照识别]]>
                                </Button.Text>
                            </Button>

                            <Button Grid.Column="1"
                                    BackgroundColor="#66BB6A"
                                    TextColor="White"
                                    CornerRadius="12"
                                    HeightRequest="80"
                                    FontSize="15"
                                    FontAttributes="Bold"
                                    Clicked="OnSelectFromGalleryClicked">
                                <Button.Text>
                                    <![CDATA[🖼️
相册选择]]>
                                </Button.Text>
                            </Button>
                        </Grid>

                        <!-- 第二行：手动输入按钮 -->
                        <Button Grid.Row="1"
                                BackgroundColor="#81C784"
                                TextColor="White"
                                CornerRadius="12"
                                HeightRequest="60"
                                FontSize="16"
                                FontAttributes="Bold"
                                Clicked="OnManualInputClicked">
                            <Button.Text>
                                <![CDATA[✏️ 手动输入餐食]]>
                            </Button.Text>
                        </Button>
                    </Grid>
                </Frame>

                <!-- 第2行：图片预览 -->
                <Frame Grid.Row="2"
                       CornerRadius="16"
                       Padding="0"
                       BorderColor="#A8C090"
                       BackgroundColor="White"
                       IsVisible="{Binding Source={x:Reference PreviewImage}, Path=IsVisible}">
                    <Image x:Name="PreviewImage"
                           Aspect="AspectFill"
                           HeightRequest="280"/>
                </Frame>

                <!-- 第3行：加载指示器 -->
                <ActivityIndicator x:Name="LoadingIndicator"
                                   Grid.Row="3"
                                   IsRunning="False"
                                   IsVisible="False"
                                   Color="#4CAF50"
                                   HorizontalOptions="Center"
                                   HeightRequest="50"
                                   WidthRequest="50"/>

                <!-- 第4行：识别结果编辑区域 -->
                <Frame x:Name="ResultFrame"
                       Grid.Row="4"
                       BorderColor="#4CAF50"
                       CornerRadius="16"
                       Padding="20"
                       BackgroundColor="White"
                       IsVisible="False">
                    <VerticalStackLayout Spacing="16">
                        <Grid ColumnDefinitions="Auto,*">
                            <Label Grid.Column="0"
                                   Text="🍽️"
                                   FontSize="24"
                                   VerticalOptions="Center"
                                   Margin="0,0,8,0"/>
                            <Label Grid.Column="1"
                                   Text="识别结果编辑"
                                   FontAttributes="Bold"
                                   FontSize="20"
                                   TextColor="#2D5016"
                                   VerticalOptions="Center"/>
                        </Grid>

                        <BoxView HeightRequest="2"
                                 Color="#E8F5E8"
                                 CornerRadius="1"/>

                        <!-- 食物名称编辑区 -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="🥘 食物名称"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#2D5016"/>

                            <Frame BorderColor="#A8C090"
                                   CornerRadius="12"
                                   Padding="16,12"
                                   BackgroundColor="#F8FDF8">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Grid Grid.Column="0">
                                        <Label x:Name="FoodNameLabel"
                                               Text="点击识别食物"
                                               FontSize="16"
                                               TextColor="#2D5016"
                                               VerticalOptions="Center">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnFoodNameTapped"/>
                                            </Label.GestureRecognizers>
                                        </Label>

                                        <Entry x:Name="FoodNameEntry"
                                               Text=""
                                               FontSize="16"
                                               TextColor="#2D5016"
                                               BackgroundColor="Transparent"
                                               IsVisible="False"
                                               Completed="OnFoodNameCompleted"
                                               Unfocused="OnFoodNameCompleted"/>
                                    </Grid>

                                    <Button Grid.Column="1"
                                            x:Name="FoodNameEditButton"
                                            Text="✏️"
                                            BackgroundColor="Transparent"
                                            TextColor="#4CAF50"
                                            FontSize="18"
                                            WidthRequest="40"
                                            HeightRequest="40"
                                            Clicked="OnFoodNameTapped"/>
                                </Grid>
                            </Frame>
                        </VerticalStackLayout>

                        <!-- 标签编辑区 -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="🏷️ 食物标签"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#2D5016"/>

                            <Frame BorderColor="#A8C090"
                                   CornerRadius="12"
                                   Padding="16,12"
                                   BackgroundColor="#F8FDF8">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Grid Grid.Column="0">
                                        <Label x:Name="FoodTagLabel"
                                               Text="暂无标签"
                                               FontSize="16"
                                               TextColor="#7B9A5C"
                                               VerticalOptions="Center">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnFoodTagTapped"/>
                                            </Label.GestureRecognizers>
                                        </Label>

                                        <Entry x:Name="FoodTagEntry"
                                               Text=""
                                               FontSize="16"
                                               TextColor="#2D5016"
                                               BackgroundColor="Transparent"
                                               IsVisible="False"
                                               Completed="OnFoodTagCompleted"
                                               Unfocused="OnFoodTagCompleted"/>
                                    </Grid>

                                    <Button Grid.Column="1"
                                            x:Name="FoodTagEditButton"
                                            Text="✏️"
                                            BackgroundColor="Transparent"
                                            TextColor="#4CAF50"
                                            FontSize="18"
                                            WidthRequest="40"
                                            HeightRequest="40"
                                            Clicked="OnFoodTagTapped"/>
                                </Grid>
                            </Frame>
                        </VerticalStackLayout>

                        <!-- 操作按钮 -->
                        <Grid ColumnDefinitions="*,*"
                              ColumnSpacing="12"
                              Margin="0,8,0,0">
                            <Button Grid.Column="0"
                                    Text="✅ 保存记录"
                                    BackgroundColor="#4CAF50"
                                    TextColor="White"
                                    CornerRadius="12"
                                    HeightRequest="50"
                                    FontSize="16"
                                    FontAttributes="Bold"
                                    Clicked="OnSaveMealClicked"/>

                            <Button Grid.Column="1"
                                    Text="❌ 取消"
                                    BackgroundColor="#A8C090"
                                    TextColor="White"
                                    CornerRadius="12"
                                    HeightRequest="50"
                                    FontSize="16"
                                    FontAttributes="Bold"
                                    Clicked="OnCancelClicked"/>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- 第5行：分隔线 -->
                <Grid Grid.Row="5"
                      ColumnDefinitions="*,Auto,*"
                      VerticalOptions="Center"
                      Margin="0,20,0,10">
                    <BoxView Grid.Column="0"
                             HeightRequest="2"
                             BackgroundColor="#E8F5E8"
                             CornerRadius="1"
                             VerticalOptions="Center"/>
                    <Frame Grid.Column="1"
                           BackgroundColor="#4CAF50"
                           CornerRadius="16"
                           Padding="16,8"
                           BorderColor="Transparent"
                           Margin="16,0">
                        <Label Text="📅 用餐历史"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="White"/>
                    </Frame>
                    <BoxView Grid.Column="2"
                             HeightRequest="2"
                             BackgroundColor="#E8F5E8"
                             CornerRadius="1"
                             VerticalOptions="Center"/>
                </Grid>

                <!-- 第6行：用餐历史区域 -->
                <Frame Grid.Row="6"
                       BorderColor="#E8F5E8"
                       CornerRadius="16"
                       Padding="0"
                       BackgroundColor="White"
                       HasShadow="True">
                    <VerticalStackLayout Spacing="0">
                        <!-- 历史记录头部 -->
                        <Grid ColumnDefinitions="*,Auto"
                              Padding="20,16"
                              BackgroundColor="#F8FDF8">
                            <VerticalStackLayout Grid.Column="0"
                                                 Spacing="2">
                                <Label Text="🍽️ 最近用餐记录"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="#2D5016"/>
                                <Label Text="追踪您的健康饮食轨迹"
                                       FontSize="12"
                                       TextColor="#7B9A5C"/>
                            </VerticalStackLayout>
                            <Button Grid.Column="1"
                                    x:Name="RefreshHistoryButton"
                                    Text="🔄"
                                    BackgroundColor="#4CAF50"
                                    TextColor="White"
                                    FontSize="16"
                                    WidthRequest="45"
                                    HeightRequest="45"
                                    CornerRadius="20"
                                    Clicked="OnRefreshHistoryClicked"/>
                        </Grid>

                        <!-- 历史记录列表 -->
                        <CollectionView x:Name="MealHistoryCollectionView"
                                        BackgroundColor="Transparent"
                                        SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="16,12"
                                          RowDefinitions="Auto,Auto,Auto"
                                          ColumnDefinitions="60,*,Auto">

                                        <!-- 时间线圆点和线条 -->
                                        <Grid Grid.Row="0"
                                              Grid.RowSpan="3"
                                              Grid.Column="0"
                                              VerticalOptions="Fill"
                                              HorizontalOptions="Center">
                                            <BoxView WidthRequest="2"
                                                     BackgroundColor="#E0E0E0"
                                                     VerticalOptions="Fill"
                                                     HorizontalOptions="Center"/>
                                            <Ellipse Fill="#4CAF50"
                                                     WidthRequest="12"
                                                     HeightRequest="12"
                                                     VerticalOptions="Start"
                                                     HorizontalOptions="Center"
                                                     Margin="0,8,0,0"/>
                                        </Grid>

                                        <!-- 餐食信息 -->
                                        <VerticalStackLayout Grid.Row="0"
                                                             Grid.Column="1"
                                                             Spacing="4"
                                                             Margin="12,0,0,0">
                                            <Grid ColumnDefinitions="*,Auto">
                                                <Label Grid.Column="0"
                                                       Text="{Binding MealType}"
                                                       FontSize="16"
                                                       FontAttributes="Bold"
                                                       TextColor="#333"/>
                                                <Label Grid.Column="1"
                                                       FontSize="12"
                                                       TextColor="#666">
                                                    <Label.Text>
                                                        <MultiBinding StringFormat="{}{0:MM/dd} {1:HH:mm}">
                                                            <Binding Path="MealDate"/>
                                                            <Binding Path="MealTime"/>
                                                        </MultiBinding>
                                                    </Label.Text>
                                                </Label>
                                            </Grid>
                                        </VerticalStackLayout>

                                        <!-- 食物列表 -->
                                        <CollectionView Grid.Row="1"
                                                        Grid.Column="1"
                                                        ItemsSource="{Binding MealFoodImages}"
                                                        Margin="12,8,0,0">
                                            <CollectionView.ItemsLayout>
                                                <LinearItemsLayout Orientation="Horizontal"
                                                                   ItemSpacing="8"/>
                                            </CollectionView.ItemsLayout>
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                    <Frame BorderColor="#E0E0E0"
                                                           CornerRadius="8"
                                                           Padding="8,4"
                                                           BackgroundColor="#F8F9FA"
                                                           HasShadow="False">
                                                        <Grid ColumnDefinitions="Auto,*">
                                                            <!-- 食物图片缩略图 -->
                                                            <Frame Grid.Column="0"
                                                                   CornerRadius="4"
                                                                   Padding="0"
                                                                   WidthRequest="24"
                                                                   HeightRequest="24"
                                                                   BorderColor="Transparent"
                                                                   BackgroundColor="LightGray">
                                                                <Frame.GestureRecognizers>
                                                                    <TapGestureRecognizer Tapped="OnThumbnailTapped"/>
                                                                </Frame.GestureRecognizers>
                                                                <Grid>
                                                                    <!-- 默认图标 -->
                                                                    <Label Text="🍽️"
                                                                           FontSize="12"
                                                                           HorizontalOptions="Center"
                                                                           VerticalOptions="Center"
                                                                           TextColor="#999"/>

                                                                    <!-- 实际图片 -->
                                                                    <Image Aspect="AspectFill"
                                                                           BackgroundColor="Transparent">
                                                                        <Image.Source>
                                                                            <UriImageSource Uri="{Binding ImageUrl}"
                                                                                            CachingEnabled="True"
                                                                                            CacheValidity="7"/>
                                                                        </Image.Source>
                                                                        <Image.Triggers>
                                                                            <DataTrigger TargetType="Image"
                                                                                         Binding="{Binding ImageUrl}"
                                                                                         Value="">
                                                                                <Setter Property="IsVisible"
                                                                                        Value="False"/>
                                                                            </DataTrigger>
                                                                            <DataTrigger TargetType="Image"
                                                                                         Binding="{Binding ImageUrl}"
                                                                                         Value="{x:Null}">
                                                                                <Setter Property="IsVisible"
                                                                                        Value="False"/>
                                                                            </DataTrigger>
                                                                        </Image.Triggers>
                                                                    </Image>
                                                                </Grid>
                                                            </Frame>

                                                            <!-- 食物名称 -->
                                                            <Label Grid.Column="1"
                                                                   Text="{Binding Food.Name}"
                                                                   FontSize="12"
                                                                   TextColor="#555"
                                                                   VerticalOptions="Center"
                                                                   Margin="4,0,0,0"/>
                                                        </Grid>
                                                    </Frame>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>

                                        <!-- 标签列表 -->
                                        <CollectionView Grid.Row="2"
                                                        Grid.Column="1"
                                                        ItemsSource="{Binding MealFoodTags}"
                                                        Margin="12,4,0,8">
                                            <CollectionView.ItemsLayout>
                                                <LinearItemsLayout Orientation="Horizontal"
                                                                   ItemSpacing="4"/>
                                            </CollectionView.ItemsLayout>
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                    <Border BackgroundColor="#E3F2FD"
                                                            Stroke="#2196F3"
                                                            StrokeThickness="1"
                                                            StrokeShape="RoundRectangle 10">
                                                        <Label Text="{Binding Tag.TagName}"
                                                               FontSize="10"
                                                               TextColor="#1976D2"
                                                               Padding="6,2"/>
                                                    </Border>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>

                                        <!-- 分隔线 -->
                                        <BoxView Grid.Row="3"
                                                 Grid.Column="1"
                                                 Grid.ColumnSpan="2"
                                                 HeightRequest="1"
                                                 BackgroundColor="#F0F0F0"
                                                 Margin="8,8,10,-20"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <!-- 空状态提示 -->
                        <VerticalStackLayout x:Name="EmptyStateLayout"
                                             Spacing="12"
                                             Padding="40,60"
                                             HorizontalOptions="Center"
                                             IsVisible="False">
                            <Label Text="🍽️"
                                   FontSize="48"
                                   HorizontalOptions="Center"
                                   Opacity="0.3"/>
                            <Label Text="暂无用餐记录"
                                   FontSize="16"
                                   TextColor="#999"
                                   HorizontalOptions="Center"/>
                            <Label Text="开始记录您的第一餐吧！"
                                   FontSize="12"
                                   TextColor="#CCC"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>

                        <!-- 查看更多按钮 -->
                        <Button x:Name="ViewMoreButton"
                                Text="查看更多历史记录 →"
                                BackgroundColor="Transparent"
                                TextColor="#81C784"
                                FontSize="14"
                                Margin="16,8,16,16"
                                Clicked="OnViewMoreHistoryClicked"/>
                    </VerticalStackLayout>
                </Frame>
            </Grid>
        </ScrollView>

        <!-- 手动输入弹窗 -->
        <Grid x:Name="ManualInputOverlay"
              IsVisible="False"
              BackgroundColor="#90000000"
              HorizontalOptions="Fill"
              VerticalOptions="Fill"
              ZIndex="999">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnManualInputOverlayTapped"/>
            </Grid.GestureRecognizers>

            <Frame BackgroundColor="White"
                   CornerRadius="16"
                   Padding="0"
                   MaximumWidthRequest="400"
                   MaximumHeightRequest="600"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   HasShadow="True"
                   Margin="20">
                <ScrollView>
                    <VerticalStackLayout Spacing="0">
                        <!-- 标题栏 -->
                        <Grid ColumnDefinitions="*,Auto"
                              Padding="20,16"
                              BackgroundColor="#F8F9FA">
                            <Label Grid.Column="0"
                                   Text="手动输入餐食"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="#333"
                                   VerticalOptions="Center"/>
                            <Button Grid.Column="1"
                                    Text="✕"
                                    BackgroundColor="Transparent"
                                    TextColor="#666"
                                    FontSize="18"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    Clicked="OnCloseManualInputClicked"/>
                        </Grid>

                        <!-- 内容区域 -->
                        <VerticalStackLayout Spacing="20"
                                             Padding="20">
                            <!-- 食物选择区域 -->
                            <VerticalStackLayout Spacing="12">
                                <Label Text="🍽️ 食物名称"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="#333"/>

                                <!-- 历史食物选择 -->
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="选择历史食物："
                                           FontSize="14"
                                           TextColor="#666"/>
                                    <CollectionView x:Name="HistoryFoodCollectionView"
                                                    MaximumHeightRequest="50"
                                                    BackgroundColor="Transparent">
                                        <CollectionView.ItemsLayout>
                                            <LinearItemsLayout Orientation="Horizontal"
                                                               ItemSpacing="8"/>
                                        </CollectionView.ItemsLayout>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Border x:Name="FoodBorder"
                                                        BackgroundColor="#F8F9FA"
                                                        Stroke="#DDD"
                                                        StrokeThickness="1"
                                                        HeightRequest="45"
                                                        StrokeShape="RoundRectangle 8"
                                                        Padding="12,6">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer Tapped="OnHistoryFoodTapped"/>
                                                    </Border.GestureRecognizers>
                                                    <Label Text="{Binding Name}"
                                                           FontSize="14"
                                                           TextColor="#333"
                                                           VerticalOptions="Center"/>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>

                                <!-- 食物名称输入 -->
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="或输入新食物名称："
                                           FontSize="14"
                                           TextColor="#666"/>
                                    <Entry x:Name="ManualFoodNameEntry"
                                           Placeholder="请输入食物名称"
                                           FontSize="16"
                                           BackgroundColor="White"/>
                                </VerticalStackLayout>
                            </VerticalStackLayout>

                            <!-- 分隔线 -->
                            <BoxView HeightRequest="1"
                                     BackgroundColor="#E0E0E0"/>

                            <!-- 标签选择区域 -->
                            <VerticalStackLayout Spacing="12">
                                <Label Text="🏷️ 食物标签"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="#333"/>

                                <!-- 历史标签选择 -->
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="选择历史标签（可多选）："
                                           FontSize="14"
                                           TextColor="#666"/>
                                    <CollectionView x:Name="HistoryTagCollectionView"
                                                    MaximumHeightRequest="50"
                                                    BackgroundColor="Transparent">
                                        <CollectionView.ItemsLayout>
                                            <LinearItemsLayout Orientation="Horizontal"
                                                               ItemSpacing="6"/>
                                        </CollectionView.ItemsLayout>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Border x:Name="TagBorder"
                                                        BackgroundColor="#E3F2FD"
                                                        Stroke="#2196F3"
                                                        StrokeThickness="1"
                                                        StrokeShape="RoundRectangle 12"
                                                        HeightRequest="45"
                                                        Padding="10,0">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer Tapped="OnHistoryTagTapped"/>
                                                    </Border.GestureRecognizers>
                                                    <Label Text="{Binding TagName}"
                                                           FontSize="12"
                                                           TextColor="#1976D2"
                                                           VerticalOptions="Center"/>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>

                                <!-- 选中的标签显示 -->
                                <VerticalStackLayout x:Name="SelectedTagsLayout"
                                                     Spacing="8"
                                                     IsVisible="False">
                                    <Label Text="已选择的标签："
                                           FontSize="14"
                                           TextColor="#666"/>
                                    <CollectionView x:Name="SelectedTagsCollectionView"
                                                    BackgroundColor="Transparent">
                                        <CollectionView.ItemsLayout>
                                            <LinearItemsLayout Orientation="Horizontal"
                                                               ItemSpacing="6"/>
                                        </CollectionView.ItemsLayout>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Border BackgroundColor="#4CAF50"
                                                        Stroke="#4CAF50"
                                                        StrokeThickness="1"
                                                        StrokeShape="RoundRectangle 12"
                                                        Padding="10,4">
                                                    <Grid ColumnDefinitions="*,Auto">
                                                        <Label Grid.Column="0"
                                                               Text="{Binding TagName}"
                                                               FontSize="12"
                                                               TextColor="White"
                                                               VerticalOptions="Center"/>
                                                        <Button Grid.Column="1"
                                                                Text="×"
                                                                BackgroundColor="Transparent"
                                                                TextColor="White"
                                                                FontSize="14"
                                                                WidthRequest="20"
                                                                HeightRequest="20"
                                                                Padding="0"
                                                                Clicked="OnRemoveSelectedTagClicked"/>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>

                                <!-- 新标签输入 -->
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="或输入新标签："
                                           FontSize="14"
                                           TextColor="#666"/>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <Entry Grid.Column="0"
                                               x:Name="ManualTagEntry"
                                               Placeholder="请输入标签名称"
                                               FontSize="16"
                                               BackgroundColor="White"/>
                                        <Button Grid.Column="1"
                                                Text="添加"
                                                BackgroundColor="#4CAF50"
                                                TextColor="White"
                                                CornerRadius="4"
                                                FontSize="12"
                                                WidthRequest="60"
                                                HeightRequest="40"
                                                Clicked="OnAddNewTagClicked"/>
                                    </Grid>
                                </VerticalStackLayout>
                            </VerticalStackLayout>

                            <!-- 操作按钮 -->
                            <Grid ColumnDefinitions="*,*"
                                  ColumnSpacing="12"
                                  Margin="0,20,0,0">
                                <Button Grid.Column="0"
                                        Text="✅ 保存"
                                        BackgroundColor="#4CAF50"
                                        TextColor="White"
                                        CornerRadius="8"
                                        HeightRequest="50"
                                        FontSize="16"
                                        Clicked="OnSaveManualInputClicked"/>

                                <Button Grid.Column="1"
                                        Text="❌ 取消"
                                        BackgroundColor="#FF6B6B"
                                        TextColor="White"
                                        CornerRadius="8"
                                        HeightRequest="50"
                                        FontSize="16"
                                        Clicked="OnCloseManualInputClicked"/>
                            </Grid>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </ScrollView>
            </Frame>
        </Grid>

        <!-- 图片预览弹窗 - 移到最外层以覆盖整个页面 -->
        <Grid x:Name="ImagePreviewOverlay"
              IsVisible="False"
              BackgroundColor="#90000000"
              HorizontalOptions="Fill"
              VerticalOptions="Fill"
              ZIndex="1000">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnOverlayTapped"/>
            </Grid.GestureRecognizers>

            <Frame BackgroundColor="White"
                   CornerRadius="16"
                   Padding="0"
                   MaximumWidthRequest="380"
                   MaximumHeightRequest="500"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   HasShadow="True"
                   Margin="20">
                <VerticalStackLayout Spacing="0">
                    <!-- 关闭按钮 -->
                    <Grid ColumnDefinitions="*,Auto"
                          Padding="10,6,10,12"
                          BackgroundColor="#F8F9FA">
                        <Label Grid.Column="0"
                               x:Name="PreviewTitle"
                               Text="食物图片"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="#333"
                               VerticalOptions="Center"/>
                        <Button Grid.Column="1"
                                Text="✕"
                                BackgroundColor="Transparent"
                                TextColor="#666"
                                FontSize="15"
                                WidthRequest="50"
                                HeightRequest="40"
                                Clicked="OnClosePreviewClicked"/>
                    </Grid>

                    <!-- 大图显示 -->
                    <Frame Padding="16"
                           BackgroundColor="White">
                        <Image x:Name="PopupPreviewImage"
                               MaximumWidthRequest="340"
                               MaximumHeightRequest="340"
                               Aspect="AspectFit"
                               BackgroundColor="#F5F5F5"/>
                    </Frame>

                    <!-- 图片信息 -->
                    <Grid Padding="20,12,20,20"
                          ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0"
                               x:Name="PreviewInfo"
                               Text="点击空白处关闭"
                               FontSize="12"
                               TextColor="#666"
                               VerticalOptions="Center"/>
                        <Button Grid.Column="1"
                                Text="🔗 查看原图"
                                BackgroundColor="Transparent"
                                TextColor="#81C784"
                                FontSize="12"
                                Clicked="OnViewOriginalClicked"/>
                    </Grid>
                </VerticalStackLayout>
            </Frame>
        </Grid>
    </Grid>
</ContentPage>