<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="WTEMaui.Views.DashboardPage"
             Title="é£Ÿç‰©è¯†åˆ«"
             BackgroundColor="#F5F5F5">

    <!-- ä½¿ç”¨Gridä½œä¸ºæ ¹å®¹å™¨ï¼Œä»¥ä¾¿å åŠ å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
    <Grid>
        <ScrollView>
            <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto"
                  RowSpacing="20"
                  Padding="20">

                <!-- ç¬¬0è¡Œï¼šæ ‡é¢˜ -->
                <Label Text="é£Ÿç‰©è¯†åˆ«"
                       Grid.Row="0"
                       HorizontalOptions="Center"
                       FontSize="24"
                       FontAttributes="Bold"
                       TextColor="#512BD4"/>

                <!-- ç¬¬1è¡Œï¼šæ‹ç…§æŒ‰é’® -->
                <Button Text="ðŸ“· æ‹ç…§è¯†åˆ«é£Ÿç‰©"
                        Grid.Row="1"
                        BackgroundColor="#512BD4"
                        TextColor="White"
                        CornerRadius="10"
                        HeightRequest="60"
                        FontSize="18"
                        Clicked="OnTakePhotoClicked"/>

                <!-- ç¬¬1.5è¡Œï¼šä»Žç›¸å†Œé€‰æ‹©æŒ‰é’® -->
                <Button Text="ðŸ–¼ï¸ ä»Žç›¸å†Œé€‰æ‹©"
                        Grid.Row="2"
                        BackgroundColor="#FF6B35"
                        TextColor="White"
                        CornerRadius="10"
                        HeightRequest="60"
                        FontSize="18"
                        Margin="0,5,0,0"
                        Clicked="OnSelectFromGalleryClicked"/>

                <!-- ç¬¬1.6è¡Œï¼šæ‰‹åŠ¨è¾“å…¥æŒ‰é’® -->
                <Button Text="âœï¸ æ‰‹åŠ¨è¾“å…¥"
                        Grid.Row="3"
                        BackgroundColor="#28A745"
                        TextColor="White"
                        CornerRadius="10"
                        HeightRequest="60"
                        FontSize="18"
                        Margin="0,5,0,0"
                        Clicked="OnManualInputClicked"/>

                <!-- ç¬¬2è¡Œï¼šå›¾ç‰‡é¢„è§ˆ -->
                <Frame Grid.Row="2"
                       CornerRadius="15"
                       Padding="0"
                       BorderColor="#DDDDDD"
                       Margin="0,80,0,0"
                       IsVisible="{Binding Source={x:Reference PreviewImage}, Path=IsVisible}">
                    <Image x:Name="PreviewImage"
                           Aspect="AspectFill"
                           HeightRequest="300"/>
                </Frame>

                <!-- ç¬¬3è¡Œï¼šåŠ è½½æŒ‡ç¤ºå™¨ -->
                <ActivityIndicator x:Name="LoadingIndicator"
                                   Grid.Row="3"
                                   IsRunning="False"
                                   Color="#512BD4"
                                   HorizontalOptions="Center"
                                   HeightRequest="50"
                                   WidthRequest="50"/>

                <!-- ç¬¬4è¡Œï¼šè¯†åˆ«ç»“æžœç¼–è¾‘åŒºåŸŸ -->
                <Frame x:Name="ResultFrame"
                       Grid.Row="4"
                       BorderColor="#512BD4"
                       CornerRadius="10"
                       Padding="15"
                       IsVisible="False">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="ðŸ½ï¸ è¯†åˆ«ç»“æžœ" 
                               FontAttributes="Bold"
                               FontSize="18"
                               TextColor="#512BD4"/>

                        <BoxView HeightRequest="1"
                                 Color="#512BD4"
                                 Margin="0,0,0,10"/>

                        <!-- é£Ÿç‰©åç§°ç¼–è¾‘åŒº -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="é£Ÿç‰©åç§°:" 
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#333"/>
                            
                            <Grid ColumnDefinitions="*,Auto">
                                <Frame Grid.Column="0"
                                       BorderColor="#DDDDDD"
                                       CornerRadius="5"
                                       Padding="10,8"
                                       BackgroundColor="White">
                                    <Grid>
                                        <Label x:Name="FoodNameLabel"
                                               Text="ç‚¹å‡»è¯†åˆ«é£Ÿç‰©"
                                               FontSize="16"
                                               TextColor="#333"
                                               VerticalOptions="Center">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnFoodNameTapped"/>
                                            </Label.GestureRecognizers>
                                        </Label>
                                        
                                        <Entry x:Name="FoodNameEntry"
                                               Text=""
                                               FontSize="16"
                                               IsVisible="False"
                                               Completed="OnFoodNameCompleted"
                                               Unfocused="OnFoodNameCompleted"/>
                                    </Grid>
                                </Frame>
                                
                                <Button Grid.Column="1"
                                        x:Name="FoodNameEditButton"
                                        Text="âœï¸"
                                        BackgroundColor="Transparent"
                                        TextColor="#512BD4"
                                        FontSize="18"
                                        WidthRequest="40"
                                        HeightRequest="40"
                                        Clicked="OnFoodNameTapped"/>
                            </Grid>
                        </VerticalStackLayout>

                        <!-- æ ‡ç­¾ç¼–è¾‘åŒº -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="é£Ÿç‰©æ ‡ç­¾:" 
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#333"/>
                            
                            <Grid ColumnDefinitions="*,Auto">
                                <Frame Grid.Column="0"
                                       BorderColor="#DDDDDD"
                                       CornerRadius="5"
                                       Padding="10,8"
                                       BackgroundColor="White">
                                    <Grid>
                                        <Label x:Name="FoodTagLabel"
                                               Text="æš‚æ— æ ‡ç­¾"
                                               FontSize="16"
                                               TextColor="#666"
                                               VerticalOptions="Center">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnFoodTagTapped"/>
                                            </Label.GestureRecognizers>
                                        </Label>
                                        
                                        <Entry x:Name="FoodTagEntry"
                                               Text=""
                                               FontSize="16"
                                               IsVisible="False"
                                               Completed="OnFoodTagCompleted"
                                               Unfocused="OnFoodTagCompleted"/>
                                    </Grid>
                                </Frame>
                                
                                <Button Grid.Column="1"
                                        x:Name="FoodTagEditButton"
                                        Text="âœï¸"
                                        BackgroundColor="Transparent"
                                        TextColor="#512BD4"
                                        FontSize="18"
                                        WidthRequest="40"
                                        HeightRequest="40"
                                        Clicked="OnFoodTagTapped"/>
                            </Grid>
                        </VerticalStackLayout>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10" Margin="0,10,0,0">
                            <Button Grid.Column="0"
                                    Text="âœ… ä¿å­˜"
                                    BackgroundColor="#512BD4"
                                    TextColor="White"
                                    CornerRadius="5"
                                    HeightRequest="45"
                                    Clicked="OnSaveMealClicked"/>
                            
                            <Button Grid.Column="1"
                                    Text="âŒ å–æ¶ˆ"
                                    BackgroundColor="#FF6B6B"
                                    TextColor="White"
                                    CornerRadius="5"
                                    HeightRequest="45"
                                    Clicked="OnCancelClicked"/>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- ç¬¬5è¡Œï¼šåˆ†éš”çº¿ -->
                <Grid Grid.Row="5" 
                      ColumnDefinitions="*,Auto,*" 
                      VerticalOptions="Center"
                      Margin="0,20,0,10">
                    <BoxView Grid.Column="0" 
                             HeightRequest="1" 
                             BackgroundColor="#DDDDDD" 
                             VerticalOptions="Center"/>
                    <Label Grid.Column="1" 
                           Text="ç”¨é¤åŽ†å²" 
                           FontSize="16" 
                           FontAttributes="Bold" 
                           TextColor="#666" 
                           Margin="15,0"/>
                    <BoxView Grid.Column="2" 
                             HeightRequest="1" 
                             BackgroundColor="#DDDDDD" 
                             VerticalOptions="Center"/>
                </Grid>

                <!-- ç¬¬6è¡Œï¼šç”¨é¤åŽ†å²åŒºåŸŸ -->
                <Frame Grid.Row="6"
                       BorderColor="#E0E0E0"
                       CornerRadius="12"
                       Padding="0"
                       BackgroundColor="White"
                       HasShadow="True">
                    <VerticalStackLayout Spacing="0">
                        <!-- åŽ†å²è®°å½•å¤´éƒ¨ -->
                        <Grid ColumnDefinitions="*,Auto" 
                              Padding="16,12"
                              BackgroundColor="#F8F9FA">
                            <Label Grid.Column="0"
                                   Text="ðŸ“… æœ€è¿‘ç”¨é¤è®°å½•"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#333"
                                   VerticalOptions="Center"/>
                            <Button Grid.Column="1"
                                    x:Name="RefreshHistoryButton"
                                    Text="åˆ·æ–°"
                                    BackgroundColor="Transparent"
                                    TextColor="#512BD4"
                                    FontSize="12"
                                    WidthRequest="60"
                                    HeightRequest="40"
                                    Clicked="OnRefreshHistoryClicked"/>
                        </Grid>

                        <!-- åŽ†å²è®°å½•åˆ—è¡¨ -->
                        <CollectionView x:Name="MealHistoryCollectionView"
                                        BackgroundColor="Transparent"
                                        SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="16,12" 
                                          RowDefinitions="Auto,Auto,Auto"
                                          ColumnDefinitions="60,*,Auto">
                                        
                                        <!-- æ—¶é—´çº¿åœ†ç‚¹å’Œçº¿æ¡ -->
                                        <Grid Grid.Row="0" Grid.RowSpan="3" Grid.Column="0" 
                                              VerticalOptions="Fill"
                                              HorizontalOptions="Center">
                                            <BoxView WidthRequest="2" 
                                                     BackgroundColor="#E0E0E0" 
                                                     VerticalOptions="Fill" 
                                                     HorizontalOptions="Center"/>
                                            <Ellipse Fill="#512BD4" 
                                                     WidthRequest="12" 
                                                     HeightRequest="12" 
                                                     VerticalOptions="Start" 
                                                     HorizontalOptions="Center"
                                                     Margin="0,8,0,0"/>
                                        </Grid>

                                        <!-- é¤é£Ÿä¿¡æ¯ -->
                                        <VerticalStackLayout Grid.Row="0" Grid.Column="1" 
                                                             Spacing="4" 
                                                             Margin="12,0,0,0">
                                            <Grid ColumnDefinitions="*,Auto">
                                                <Label Grid.Column="0"
                                                       Text="{Binding MealType}"
                                                       FontSize="16"
                                                       FontAttributes="Bold"
                                                       TextColor="#333"/>
                                                <Label Grid.Column="1"
                                                       FontSize="12"
                                                       TextColor="#666">
                                                    <Label.Text>
                                                        <MultiBinding StringFormat="{}{0:MM/dd} {1:HH:mm}">
                                                            <Binding Path="MealDate"/>
                                                            <Binding Path="MealTime"/>
                                                        </MultiBinding>
                                                    </Label.Text>
                                                </Label>
                                            </Grid>
                                        </VerticalStackLayout>

                                        <!-- é£Ÿç‰©åˆ—è¡¨ -->
                                        <CollectionView Grid.Row="1" Grid.Column="1" 
                                                        ItemsSource="{Binding MealFoodImages}"
                                                        Margin="12,8,0,0">
                                            <CollectionView.ItemsLayout>
                                                <LinearItemsLayout Orientation="Horizontal" ItemSpacing="8"/>
                                            </CollectionView.ItemsLayout>
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                    <Frame BorderColor="#E0E0E0"
                                                           CornerRadius="8"
                                                           Padding="8,4"
                                                           BackgroundColor="#F8F9FA"
                                                           HasShadow="False">
                                                        <Grid ColumnDefinitions="Auto,*">
                                                            <!-- é£Ÿç‰©å›¾ç‰‡ç¼©ç•¥å›¾ -->
                                                            <Frame Grid.Column="0"
                                                                   CornerRadius="4"
                                                                   Padding="0"
                                                                   WidthRequest="24"
                                                                   HeightRequest="24"
                                                                   BorderColor="Transparent"
                                                                   BackgroundColor="LightGray">
                                                                <Frame.GestureRecognizers>
                                                                    <TapGestureRecognizer Tapped="OnThumbnailTapped"/>
                                                                </Frame.GestureRecognizers>
                                                                <Grid>
                                                                    <!-- é»˜è®¤å›¾æ ‡ -->
                                                                    <Label Text="ðŸ½ï¸" 
                                                                           FontSize="12" 
                                                                           HorizontalOptions="Center" 
                                                                           VerticalOptions="Center"
                                                                           TextColor="#999"/>
                                                                    
                                                                    <!-- å®žé™…å›¾ç‰‡ -->
                                                                    <Image Aspect="AspectFill"
                                                                           BackgroundColor="Transparent">
                                                                        <Image.Source>
                                                                            <UriImageSource Uri="{Binding ImageUrl}" 
                                                                                          CachingEnabled="True" 
                                                                                          CacheValidity="7"/>
                                                                        </Image.Source>
                                                                        <Image.Triggers>
                                                                            <DataTrigger TargetType="Image" 
                                                                                       Binding="{Binding ImageUrl}" 
                                                                                       Value="">
                                                                                <Setter Property="IsVisible" Value="False"/>
                                                                            </DataTrigger>
                                                                            <DataTrigger TargetType="Image" 
                                                                                       Binding="{Binding ImageUrl}" 
                                                                                       Value="{x:Null}">
                                                                                <Setter Property="IsVisible" Value="False"/>
                                                                            </DataTrigger>
                                                                        </Image.Triggers>
                                                                    </Image>
                                                                </Grid>
                                                            </Frame>
                                                            
                                                            <!-- é£Ÿç‰©åç§° -->
                                                            <Label Grid.Column="1"
                                                                   Text="{Binding Food.Name}"
                                                                   FontSize="12"
                                                                   TextColor="#555"
                                                                   VerticalOptions="Center"
                                                                   Margin="4,0,0,0"/>
                                                        </Grid>
                                                    </Frame>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>

                                        <!-- æ ‡ç­¾åˆ—è¡¨ -->
                                        <CollectionView Grid.Row="2" Grid.Column="1" 
                                                        ItemsSource="{Binding MealFoodTags}"
                                                        Margin="12,4,0,8">
                                            <CollectionView.ItemsLayout>
                                                <LinearItemsLayout Orientation="Horizontal" ItemSpacing="4"/>
                                            </CollectionView.ItemsLayout>
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                    <Border BackgroundColor="#E3F2FD"
                                                            Stroke="#2196F3"
                                                            StrokeThickness="1"
                                                            StrokeShape="RoundRectangle 10">
                                                        <Label Text="{Binding Tag.TagName}"
                                                               FontSize="10"
                                                               TextColor="#1976D2"
                                                               Padding="6,2"/>
                                                    </Border>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>

                                        <!-- åˆ†éš”çº¿ -->
                                        <BoxView Grid.Row="3" Grid.Column="1" Grid.ColumnSpan="2"
                                                 HeightRequest="1"
                                                 BackgroundColor="#F0F0F0"
                                                 Margin="8,8,10,-20"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <!-- ç©ºçŠ¶æ€æç¤º -->
                        <VerticalStackLayout x:Name="EmptyStateLayout"
                                             Spacing="12"
                                             Padding="40,60"
                                             HorizontalOptions="Center"
                                             IsVisible="False">
                            <Label Text="ðŸ½ï¸"
                                   FontSize="48"
                                   HorizontalOptions="Center"
                                   Opacity="0.3"/>
                            <Label Text="æš‚æ— ç”¨é¤è®°å½•"
                                   FontSize="16"
                                   TextColor="#999"
                                   HorizontalOptions="Center"/>
                            <Label Text="å¼€å§‹è®°å½•æ‚¨çš„ç¬¬ä¸€é¤å§ï¼"
                                   FontSize="12"
                                   TextColor="#CCC"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>

                        <!-- æŸ¥çœ‹æ›´å¤šæŒ‰é’® -->
                        <Button x:Name="ViewMoreButton"
                                Text="æŸ¥çœ‹æ›´å¤šåŽ†å²è®°å½• â†’"
                                BackgroundColor="Transparent"
                                TextColor="#512BD4"
                                FontSize="14"
                                Margin="16,8,16,16"
                                Clicked="OnViewMoreHistoryClicked"/>
                    </VerticalStackLayout>
                </Frame>
            </Grid>
        </ScrollView>

        <!-- æ‰‹åŠ¨è¾“å…¥å¼¹çª— -->
        <Grid x:Name="ManualInputOverlay"
              IsVisible="False"
              BackgroundColor="#90000000"
              HorizontalOptions="Fill"
              VerticalOptions="Fill"
              ZIndex="999">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnManualInputOverlayTapped"/>
            </Grid.GestureRecognizers>
            
            <Frame BackgroundColor="White"
                   CornerRadius="16"
                   Padding="0"
                   MaximumWidthRequest="400"
                   MaximumHeightRequest="600"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   HasShadow="True"
                   Margin="20">
                <ScrollView>
                    <VerticalStackLayout Spacing="0">
                        <!-- æ ‡é¢˜æ  -->
                        <Grid ColumnDefinitions="*,Auto" 
                              Padding="20,16"
                              BackgroundColor="#F8F9FA">
                            <Label Grid.Column="0"
                                   Text="æ‰‹åŠ¨è¾“å…¥é¤é£Ÿ"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="#333"
                                   VerticalOptions="Center"/>
                            <Button Grid.Column="1"
                                    Text="âœ•"
                                    BackgroundColor="Transparent"
                                    TextColor="#666"
                                    FontSize="18"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    Clicked="OnCloseManualInputClicked"/>
                        </Grid>
                        
                        <!-- å†…å®¹åŒºåŸŸ -->
                        <VerticalStackLayout Spacing="20" Padding="20">
                            <!-- é£Ÿç‰©é€‰æ‹©åŒºåŸŸ -->
                            <VerticalStackLayout Spacing="12">
                                <Label Text="ðŸ½ï¸ é£Ÿç‰©åç§°"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="#333"/>
                                
                                <!-- åŽ†å²é£Ÿç‰©é€‰æ‹© -->
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="é€‰æ‹©åŽ†å²é£Ÿç‰©ï¼š"
                                           FontSize="14"
                                           TextColor="#666"/>
                                    <CollectionView x:Name="HistoryFoodCollectionView"
                                                    MaximumHeightRequest="120"
                                                    BackgroundColor="Transparent">
                                        <CollectionView.ItemsLayout>
                                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="8"/>
                                        </CollectionView.ItemsLayout>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Border x:Name="FoodBorder"
                                                        BackgroundColor="#F8F9FA"
                                                        Stroke="#DDD"
                                                        StrokeThickness="1"
                                                        StrokeShape="RoundRectangle 8"
                                                        Padding="12,6">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer Tapped="OnHistoryFoodTapped"/>
                                                    </Border.GestureRecognizers>
                                                    <Label Text="{Binding Name}"
                                                           FontSize="14"
                                                           TextColor="#333"
                                                           VerticalOptions="Center"/>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                                
                                <!-- é£Ÿç‰©åç§°è¾“å…¥ -->
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="æˆ–è¾“å…¥æ–°é£Ÿç‰©åç§°ï¼š"
                                           FontSize="14"
                                           TextColor="#666"/>
                                    <Entry x:Name="ManualFoodNameEntry"
                                           Placeholder="è¯·è¾“å…¥é£Ÿç‰©åç§°"
                                           FontSize="16"
                                           BackgroundColor="White"/>
                                </VerticalStackLayout>
                            </VerticalStackLayout>
                            
                            <!-- åˆ†éš”çº¿ -->
                            <BoxView HeightRequest="1"
                                     BackgroundColor="#E0E0E0"/>
                            
                            <!-- æ ‡ç­¾é€‰æ‹©åŒºåŸŸ -->
                            <VerticalStackLayout Spacing="12">
                                <Label Text="ðŸ·ï¸ é£Ÿç‰©æ ‡ç­¾"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="#333"/>
                                
                                <!-- åŽ†å²æ ‡ç­¾é€‰æ‹© -->
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="é€‰æ‹©åŽ†å²æ ‡ç­¾ï¼ˆå¯å¤šé€‰ï¼‰ï¼š"
                                           FontSize="14"
                                           TextColor="#666"/>
                                    <CollectionView x:Name="HistoryTagCollectionView"
                                                    MaximumHeightRequest="150"
                                                    BackgroundColor="Transparent">
                                        <CollectionView.ItemsLayout>
                                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="6"/>
                                        </CollectionView.ItemsLayout>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Border x:Name="TagBorder"
                                                        BackgroundColor="#E3F2FD"
                                                        Stroke="#2196F3"
                                                        StrokeThickness="1"
                                                        StrokeShape="RoundRectangle 12"
                                                        Padding="10,4">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer Tapped="OnHistoryTagTapped"/>
                                                    </Border.GestureRecognizers>
                                                    <Label Text="{Binding TagName}"
                                                           FontSize="12"
                                                           TextColor="#1976D2"
                                                           VerticalOptions="Center"/>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                                
                                <!-- é€‰ä¸­çš„æ ‡ç­¾æ˜¾ç¤º -->
                                <VerticalStackLayout x:Name="SelectedTagsLayout" 
                                                     Spacing="8"
                                                     IsVisible="False">
                                    <Label Text="å·²é€‰æ‹©çš„æ ‡ç­¾ï¼š"
                                           FontSize="14"
                                           TextColor="#666"/>
                                    <CollectionView x:Name="SelectedTagsCollectionView"
                                                    BackgroundColor="Transparent">
                                        <CollectionView.ItemsLayout>
                                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="6"/>
                                        </CollectionView.ItemsLayout>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Border BackgroundColor="#4CAF50"
                                                        Stroke="#4CAF50"
                                                        StrokeThickness="1"
                                                        StrokeShape="RoundRectangle 12"
                                                        Padding="10,4">
                                                    <Grid ColumnDefinitions="*,Auto">
                                                        <Label Grid.Column="0"
                                                               Text="{Binding TagName}"
                                                               FontSize="12"
                                                               TextColor="White"
                                                               VerticalOptions="Center"/>
                                                        <Button Grid.Column="1"
                                                                Text="Ã—"
                                                                BackgroundColor="Transparent"
                                                                TextColor="White"
                                                                FontSize="14"
                                                                WidthRequest="20"
                                                                HeightRequest="20"
                                                                Padding="0"
                                                                Clicked="OnRemoveSelectedTagClicked"/>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                                
                                <!-- æ–°æ ‡ç­¾è¾“å…¥ -->
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="æˆ–è¾“å…¥æ–°æ ‡ç­¾ï¼š"
                                           FontSize="14"
                                           TextColor="#666"/>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <Entry Grid.Column="0"
                                               x:Name="ManualTagEntry"
                                               Placeholder="è¯·è¾“å…¥æ ‡ç­¾åç§°"
                                               FontSize="16"
                                               BackgroundColor="White"/>
                                        <Button Grid.Column="1"
                                                Text="æ·»åŠ "
                                                BackgroundColor="#4CAF50"
                                                TextColor="White"
                                                CornerRadius="4"
                                                FontSize="12"
                                                WidthRequest="60"
                                                HeightRequest="40"
                                                Clicked="OnAddNewTagClicked"/>
                                    </Grid>
                                </VerticalStackLayout>
                            </VerticalStackLayout>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,20,0,0">
                                <Button Grid.Column="0"
                                        Text="âœ… ä¿å­˜"
                                        BackgroundColor="#512BD4"
                                        TextColor="White"
                                        CornerRadius="8"
                                        HeightRequest="50"
                                        FontSize="16"
                                        Clicked="OnSaveManualInputClicked"/>
                                
                                <Button Grid.Column="1"
                                        Text="âŒ å–æ¶ˆ"
                                        BackgroundColor="#FF6B6B"
                                        TextColor="White"
                                        CornerRadius="8"
                                        HeightRequest="50"
                                        FontSize="16"
                                        Clicked="OnCloseManualInputClicked"/>
                            </Grid>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </ScrollView>
            </Frame>
        </Grid>

        <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— - ç§»åˆ°æœ€å¤–å±‚ä»¥è¦†ç›–æ•´ä¸ªé¡µé¢ -->
        <Grid x:Name="ImagePreviewOverlay"
              IsVisible="False"
              BackgroundColor="#90000000"
              HorizontalOptions="Fill"
              VerticalOptions="Fill"
              ZIndex="1000">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnOverlayTapped"/>
            </Grid.GestureRecognizers>
            
            <Frame BackgroundColor="White"
                   CornerRadius="16"
                   Padding="0"
                   MaximumWidthRequest="380"
                   MaximumHeightRequest="500"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   HasShadow="True"
                   Margin="20">
                <VerticalStackLayout Spacing="0">
                    <!-- å…³é—­æŒ‰é’® -->
                    <Grid ColumnDefinitions="*,Auto" 
                          Padding="10,6,10,12"
                          BackgroundColor="#F8F9FA">
                        <Label Grid.Column="0"
                               x:Name="PreviewTitle"
                               Text="é£Ÿç‰©å›¾ç‰‡"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="#333"
                               VerticalOptions="Center"/>
                        <Button Grid.Column="1"
                                Text="âœ•"
                                BackgroundColor="Transparent"
                                TextColor="#666"
                                FontSize="15"
                                WidthRequest="50"
                                HeightRequest="40"
                                Clicked="OnClosePreviewClicked"/>
                    </Grid>
                    
                    <!-- å¤§å›¾æ˜¾ç¤º -->
                    <Frame Padding="16"
                           BackgroundColor="White">
                        <Image x:Name="PopupPreviewImage"
                               MaximumWidthRequest="340"
                               MaximumHeightRequest="340"
                               Aspect="AspectFit"
                               BackgroundColor="#F5F5F5"/>
                    </Frame>
                    
                    <!-- å›¾ç‰‡ä¿¡æ¯ -->
                    <Grid Padding="20,12,20,20"
                          ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0"
                               x:Name="PreviewInfo"
                               Text="ç‚¹å‡»ç©ºç™½å¤„å…³é—­"
                               FontSize="12"
                               TextColor="#666"
                               VerticalOptions="Center"/>
                        <Button Grid.Column="1"
                                Text="ðŸ”— æŸ¥çœ‹åŽŸå›¾"
                                BackgroundColor="Transparent"
                                TextColor="#512BD4"
                                FontSize="12"
                                Clicked="OnViewOriginalClicked"/>
                    </Grid>
                </VerticalStackLayout>
            </Frame>
        </Grid>
    </Grid>
</ContentPage>